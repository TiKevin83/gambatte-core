<!DOCTYPE html>
<html>

<head>
  <script src="./libgambatte.js" type="Module"></script>
  <script src="./crc32.js"></script>
  <style>
    canvas {
      image-rendering: optimizeSpeed;
      image-rendering: -moz-crisp-edges;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: optimize-contrast;
      image-rendering: pixelated;
      -ms-interpolation-mode: nearest-neighbor;
      width: 100%;
      aspect-ratio: 10 / 9;
    }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col col-4-md" id="options">
        <div class="input-group mb-3">
          <label class="input-group-text" for="gameRom">Game ROM</label>
          <input type="file" class="form-control" id="gameRom" />
        </div>
        <div class="input-group mb-3">
          <label class="input-group-text" for="gbcBios">GBC Bios</label>
          <input type="file" class="form-control" id="gbcBios" />
        </div>
        <p>ROM Checksum: </p>
        <p id="romHash"></p>
        <button class="btn btn-danger" id="pause">Pause</button>
      </div>
      <div class="col col-8-md" id="gameArea">
        <div class="row">
          <div class="col col-2">
            <div class="row">
              <div class="col col-4"></div>
              <div class="col col-4" id="touchUp">
                <div class="">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor"
                    class="bi bi-arrow-up-square" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                      d="M15 2a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1zM0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm8.5 9.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707z" />
                  </svg>
                </div>
                <div class="col col-4"></div>
              </div>
              <div class="row">
                <div class="col col-4" id="touchLeft">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor"
                    class="bi bi-arrow-left-square" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                      d="M15 2a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1zM0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm11.5 5.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z" />
                  </svg>
                </div>
                <div class="col col-4"></div>
                <div class="col col-4" id="touchRight">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor"
                    class="bi bi-arrow-right-square" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                      d="M15 2a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1zM0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm4.5 5.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5z" />
                  </svg>
                </div>
              </div>
              <div class="row">
                <div class="col col-4"></div>
                <div class="col col-4" id="touchDown">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor"
                    class="bi bi-arrow-down-square" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                      d="M15 2a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1zM0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm8.5 2.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293z" />
                  </svg>
                </div>
                <div class="col col-4"></div>
              </div>
              <div class="row mt-5">
                <button class="btn btn-info" id="showHideControls">Options</button>
              </div>
            </div>
          </div>
          <div class="col col-8">
            <canvas id="gameboy" width="160" height="144"></canvas>
          </div>
          <div class="col col-2 fs-3">
            <div class="row">
              <div class="col col-4"></div>
              <div class="col col-4 border border-1" id="pointerenter">START</div>
              <div class="col col-4"></div>
            </div>
            <div class="row">
              <div class="col col-4 border border-1" id="touchSelect">SELECT</div>
              <div class="col col-4"></div>
              <div class="col col-4 border border-1" id="touchA">A</div>
            </div>
            <div class="row">
              <div class="col col-4"></div>
              <div class="col col-4 border border-1" id="touchB">B</div>
              <div class="col col-4"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="Module">
    import gambatteModule from './libgambatte.js';
    const gammaColor = (inputColor) => {
      return Math.pow(inputColor / 255, 2.2)
    }
    const clampToUint8 = (input) => {
      return Math.min(Math.max(input, 0), 255)
    }
    gambatteModule().then(gambatte => {
      const gambatte_revision = gambatte.cwrap('gambatte_revision', 'number');
      const gambatte_create = gambatte.cwrap('gambatte_create', 'number');
      const gambatte_loadbuf = gambatte.cwrap('gambatte_loadbuf', 'number', ['number', 'number', 'number', 'number']);
      const gambatte_loadbiosbuf = gambatte.cwrap('gambatte_loadbiosbuf', 'number', ['number', 'number', 'number']);
      const gambatte_runfor = gambatte.cwrap('gambatte_runfor', 'number', ['number', 'number', 'number', 'number', 'number']);
      const gambatte_setinputgetter = gambatte.cwrap('gambatte_setinputgetter', 'number', ['number', 'number', 'number']);

      let buttonsHeld = 0;
      let animationFrame = 0;

      const left = "ArrowLeft";
      const up = "ArrowUp";
      const right = "ArrowRight";
      const down = "ArrowDown";
      const zForSelectButton = "KeyZ";
      const xForStartButton = "KeyX";
      const cForBButton = "KeyC";
      const vForAButton = "KeyV";

      const showHideOptions = document.getElementById("showHideOptions");
      const options = document.getElementById("options");
      const gameArea = document.getElementById("gameArea");
      showHideControls.addEventListener("click", () => {
        if (options.classList.contains("d-none")) {
          options.classList.add("d-block");
          options.classList.remove("d-none");
          gameArea.classList.remove("col-12-md");
          gameArea.classList.add("col-8-md");
        } else {
          options.classList.add("d-none");
          options.classList.remove("d-block");
          gameArea.classList.remove("col-8-md");
          gameArea.classList.add("col-12-md");
        }
      });

      window.addEventListener("keydown", (event) => {
        event.preventDefault();
        buttonsHeld |=
          Number(event.code === vForAButton) * 0x01 |
          Number(event.code === cForBButton) * 0x02 |
          Number(event.code === zForSelectButton) * 0x04 |
          Number(event.code === xForStartButton) * 0x08 |
          Number(event.code === right) * 0x10 |
          Number(event.code === left) * 0x20 |
          Number(event.code === up) * 0x40 |
          Number(event.code === down) * 0x80;
      });

      window.addEventListener("keyup", (event) => {
        event.preventDefault();

        buttonsHeld &=
          Number(event.code !== vForAButton) * 0x01 |
          Number(event.code !== cForBButton) * 0x02 |
          Number(event.code !== zForSelectButton) * 0x04 |
          Number(event.code !== xForStartButton) * 0x08 |
          Number(event.code !== right) * 0x10 |
          Number(event.code !== left) * 0x20 |
          Number(event.code !== up) * 0x40 |
          Number(event.code !== down) * 0x80;
      });

      const pointerenter = document.getElementById("pointerenter");
      const touchSelect = document.getElementById("touchSelect");
      const touchA = document.getElementById("touchA");
      const touchB = document.getElementById("touchB");
      const touchUp = document.getElementById("touchUp");
      const touchLeft = document.getElementById("touchLeft");
      const touchRight = document.getElementById("touchRight");
      const touchDown = document.getElementById("touchDown");

      pointerenter.addEventListener("pointerenter", (event) => {
        event.preventDefault();
        buttonsHeld |= 0x08;
        pointerenter.classList.add("bg-info");
      });

      pointerenter.addEventListener("pointerleave", (event) => {
        event.preventDefault();
        buttonsHeld &= 0xf7;
        pointerenter.classList.remove("bg-info");
      });

      touchSelect.addEventListener("pointerenter", (event) => {
        event.preventDefault();
        buttonsHeld |= 0x04;
        touchSelect.classList.add("bg-info");
      });

      touchSelect.addEventListener("pointerleave", (event) => {
        event.preventDefault();
        buttonsHeld &= 0xfb;
        touchSelect.classList.remove("bg-info");
      });

      touchA.addEventListener("pointerenter", (event) => {
        event.preventDefault();
        buttonsHeld |= 0x01;
        touchA.classList.add("bg-info");
      });

      touchA.addEventListener("pointerleave", (event) => {
        event.preventDefault();
        buttonsHeld &= 0xfe;
        touchA.classList.remove("bg-info");
      });

      touchB.addEventListener("pointerenter", (event) => {
        event.preventDefault();
        buttonsHeld |= 0x02;
        touchB.classList.add("bg-info");
      });

      touchB.addEventListener("pointerleave", (event) => {
        event.preventDefault();
        buttonsHeld &= 0xfd;
        touchB.classList.remove("bg-info");
      });

      touchUp.addEventListener("pointerenter", (event) => {
        event.preventDefault();
        buttonsHeld |= 0x40;
        touchUp.classList.add("bg-info");
      });

      touchUp.addEventListener("pointerleave", (event) => {
        event.preventDefault();
        buttonsHeld &= 0xbf;
        touchUp.classList.remove("bg-info");
      });

      touchLeft.addEventListener("pointerenter", (event) => {
        event.preventDefault();
        buttonsHeld |= 0x20;
        touchLeft.classList.add("bg-info");
      });

      touchLeft.addEventListener("pointerleave", (event) => {
        event.preventDefault();
        buttonsHeld &= 0xdf;
        touchLeft.classList.remove("bg-info");
      });

      touchRight.addEventListener("pointerenter", (event) => {
        event.preventDefault();
        buttonsHeld |= 0x10;
        touchRight.classList.add("bg-info");
      });

      touchRight.addEventListener("pointerleave", (event) => {
        event.preventDefault();
        buttonsHeld &= 0xef;
        touchRight.classList.remove("bg-info");
      });

      touchDown.addEventListener("pointerenter", (event) => {
        event.preventDefault();
        buttonsHeld |= 0x80;
        touchDown.classList.add("bg-info");
      });

      touchDown.addEventListener("pointerleave", (event) => {
        event.preventDefault();
        buttonsHeld &= 0x7f;
        touchDown.classList.remove("bg-info");
      });

      const callback = gambatte.addFunction((unused) => buttonsHeld, 'ii');

      console.log('revision: ' + gambatte_revision());

      let romFile;
      let biosFile;
      let romData;
      let biosData;

      const romFileInput = document.getElementById("gameRom");
      const biosFileInput = document.getElementById("gbcBios");
      romFileInput.addEventListener("change", e => {
        romFile = e.target.files[0];
        romFile?.arrayBuffer().then(arrayBuffer => {
          romData = arrayBuffer;
          if (romData && biosData) {
            handleGameChange();
          }
        });
      });
      biosFileInput.addEventListener("change", e => {
        biosFile = e.target.files[0];
        biosFile?.arrayBuffer().then(arrayBuffer => {
          biosData = arrayBuffer;
          if (romData && biosData) {
            handleGameChange();
          }
        })
      });

      const pauseInput = document.getElementById("pause");

      const videoBuffer = gambatte._malloc(160 * 144 * 4);
      const audioBuffer = gambatte._malloc((35112 + 2064) * 4);
      const samples = gambatte._malloc(4);

      const handleGameChange = () => {
        const romPath = romFile.name;
        const biosPath = biosFile.name;
        const romDataArray = new Uint8Array(romData);
        document.getElementById('romHash').innerText = (CRC32.buf(romDataArray) >>> 0).toString(16);

        const gb = gambatte_create();

        const romDataPtr = gambatte._malloc(romData.byteLength);
        gambatte.HEAPU8.set(romDataArray, romDataPtr);
        console.log('rom load: ' + gambatte_loadbuf(gb, romDataPtr, romData.byteLength, 3));
        gambatte._free(romDataPtr);

        const biosDataPtr = gambatte._malloc(romData.byteLength);
        gambatte.HEAPU8.set(new Uint8Array(biosData), biosDataPtr);
        console.log('bios load: ' + gambatte_loadbiosbuf(gb, biosDataPtr, biosData.byteLength));
        gambatte._free(biosDataPtr);

        gambatte_setinputgetter(gb, callback, 0);

        const backbuffer = new ImageData(160, 144);

        const renderer = document.createElement('canvas');
        const rendererContext = renderer.getContext('2d');
        renderer.width = backbuffer.width;
        renderer.height = backbuffer.height;

        const presenter = document.getElementById('gameboy');
        const presenterContext = presenter.getContext('2d');

        const sampleRate = 48000;

        const audioContext = new AudioContext({ sampleRate });

        // reduce volume

        var gainNode = audioContext.createGain();
        gainNode.gain.value = 0.06; // 6 %
        gainNode.connect(audioContext.destination);

        const cyclesPerFrame = 35112;

        let time = 0;
        let lastBufferDuration = 0;

        const renderLoop = () => {
          if (!(audioContext.currentTime - time > 0.001 || time == 0)) {
            animationFrame = requestAnimationFrame(renderLoop);
            return;
          }
          gambatte.setValue(samples, cyclesPerFrame, 'i32');
          gambatte_runfor(gb, videoBuffer, 160, audioBuffer, samples);
          const bytesProduced = gambatte.getValue(samples, 'i32') * 4;

          // process audio output

          // divide by 2 channels, 2 bytes per 16 bit signed, and 4 to naively resample to 524k
          const audioSamples = audioContext.createBuffer(2, bytesProduced / 16, 2097152 / 4);
          const channel1Samples = audioSamples.getChannelData(0);
          const channel2Samples = audioSamples.getChannelData(1);
          for (let sample = 0; sample < channel1Samples.length; sample++) {
            // inverse of the division by 16 when creating the buffer size, same logic
            channel1Samples[sample] = (gambatte.getValue(audioBuffer + sample * 16, 'i16') / 32768.0);
            channel2Samples[sample] = (gambatte.getValue(audioBuffer + sample * 16 + 2, 'i16') / 32768.0);
          }

          // play audio

          const source = audioContext.createBufferSource();
          source.buffer = audioSamples;
          source.connect(gainNode);

          time = time == 0 ? audioContext.currentTime + 0.003 : time + lastBufferDuration;

          lastBufferDuration = source.buffer.duration;
          source.start(time);

          // process video output

          for (let i = 0; i < backbuffer.data.length; i += 4) {
            const pixel = gambatte.getValue(videoBuffer + i, 'i32');

            // libretro palette
            const gammaR = gammaColor((pixel >> 16) & 0xff);
            const gammaG = gammaColor((pixel >> 8) & 0xff);
            const gammaB = gammaColor((pixel >> 0) & 0xff);
            const shadedR = clampToUint8(Math.pow(gammaR * .87 + gammaG * .18 - gammaB * .05, 1 / 2.2) * 255 + .5);
            const shadedG = clampToUint8(Math.pow(gammaG * .66 + gammaR * .115 + gammaB * .225, 1 / 2.2) * 255 + .5);
            const shadedB = clampToUint8(Math.pow(gammaB * .79 + gammaR * .14 + gammaG * .07, 1 / 2.2) * 255 + .5);

            backbuffer.data[i + 0] = shadedR;
            backbuffer.data[i + 1] = shadedG;
            backbuffer.data[i + 2] = shadedB;
            backbuffer.data[i + 3] = 0xff;
          }

          rendererContext.putImageData(backbuffer, 0, 0);
          presenterContext.drawImage(renderer, 0, 0);

          animationFrame = requestAnimationFrame(renderLoop);
        };

        pauseInput.addEventListener("click", () => {
          if (pauseInput.innerText === "Pause") {
            pauseInput.innerText = "Play";
            cancelAnimationFrame(animationFrame);
            audioContext.suspend();
          } else {
            pauseInput.innerText = "Pause";
            animationFrame = requestAnimationFrame(renderLoop);
            audioContext.resume();
          }
        });

        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            cancelAnimationFrame(animationFrame);
            audioContext.suspend();
          } else {
            if (pauseInput.innerText === "Pause") {
              animationFrame = requestAnimationFrame(renderLoop);
              audioContext.resume();
            }
          }
        });

        animationFrame = requestAnimationFrame(renderLoop);
      }
    });
  </script>
</body>

</html>
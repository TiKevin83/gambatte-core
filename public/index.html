<!DOCTYPE html>
<html>

<head>
  <script src="./libgambatte.js"></script>
  <script src="./crc32.js"></script>
  <style>
    canvas {
      image-rendering: optimizeSpeed;
      image-rendering: -moz-crisp-edges;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: optimize-contrast;
      image-rendering: pixelated;
      -ms-interpolation-mode: nearest-neighbor;
      width: 640px;
      height: 576px;
    }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</head>

<body>
  <div class="row">
    <div class="col col-4-md">
      <div class="input-group mb-3">
        <label class="input-group-text" for="gameRom">Game ROM</label>
        <input type="file" class="form-control" id="gameRom" />
      </div>
      <div class="input-group mb-3">
        <label class="input-group-text" for="gbcBios">GBC Bios</label>
        <input type="file" class="form-control" id="gbcBios" />
      </div>
      <p>ROM Checksum: </p>
      <p id="romHash"></p>
      <button class="btn btn-danger" id="pause">Pause</button>
    </div>
    <div class="col col-8-md">
      <canvas id="gameboy" width="160" height="144"></canvas>
    </div>
  </div>
  <script>
    const gammaColor = (inputColor) => {
      return Math.pow(inputColor / 255, 2.2)
    }
    const clampToUint8 = (input) => {
      return Math.min(Math.max(input, 0), 255)
    }
    Module.onRuntimeInitialized = () => {
      const gambatte_revision = Module.cwrap('gambatte_revision', 'number');
      const gambatte_create = Module.cwrap('gambatte_create', 'number');
      const gambatte_loadbuf = Module.cwrap('gambatte_loadbuf', 'number', ['number', 'number', 'number', 'number']);
      const gambatte_loadbiosbuf = Module.cwrap('gambatte_loadbiosbuf', 'number', ['number', 'number', 'number']);
      const gambatte_runfor = Module.cwrap('gambatte_runfor', 'number', ['number', 'number', 'number', 'number', 'number']);
      const gambatte_setinputgetter = Module.cwrap('gambatte_setinputgetter', 'number', ['number', 'number', 'number']);

      let buttonsHeld = 0;
      let animationFrame = 0;

      const left = "ArrowLeft";
      const up = "ArrowUp";
      const right = "ArrowRight";
      const down = "ArrowDown";
      const zForSelectButton = "KeyZ";
      const xForStartButton = "KeyX";
      const cForBButton = "KeyC";
      const vForAButton = "KeyV";

      window.addEventListener("keydown", (event) => {
        event.preventDefault();
        buttonsHeld |=
          Number(event.code === vForAButton) * 0x01 |
          Number(event.code === cForBButton) * 0x02 |
          Number(event.code === zForSelectButton) * 0x04 |
          Number(event.code === xForStartButton) * 0x08 |
          Number(event.code === right) * 0x10 |
          Number(event.code === left) * 0x20 |
          Number(event.code === up) * 0x40 |
          Number(event.code === down) * 0x80;
      });

      window.addEventListener("keyup", (event) => {
        event.preventDefault();

        buttonsHeld &=
          Number(event.code !== vForAButton) * 0x01 |
          Number(event.code !== cForBButton) * 0x02 |
          Number(event.code !== zForSelectButton) * 0x04 |
          Number(event.code !== xForStartButton) * 0x08 |
          Number(event.code !== right) * 0x10 |
          Number(event.code !== left) * 0x20 |
          Number(event.code !== up) * 0x40 |
          Number(event.code !== down) * 0x80;
      });

      const callback = Module.addFunction((unused) => buttonsHeld, 'ii');

      console.log('revision: ' + gambatte_revision());

      let romFile;
      let biosFile;
      let romData;
      let biosData;

      const romFileInput = document.getElementById("gameRom");
      const biosFileInput = document.getElementById("gbcBios");
      romFileInput.addEventListener("change", e => {
        romFile = e.target.files[0];
        romFile?.arrayBuffer().then(arrayBuffer => {
          romData = arrayBuffer;
          if (romData && biosData) {
            handleGameChange();
          }
        });
      });
      biosFileInput.addEventListener("change", e => {
        biosFile = e.target.files[0];
        biosFile?.arrayBuffer().then(arrayBuffer => {
          biosData = arrayBuffer;
          if (romData && biosData) {
            handleGameChange();
          }
        })
      });

      const pauseInput = document.getElementById("pause");

      const videoBuffer = Module._malloc(160 * 144 * 4);
      const audioBuffer = Module._malloc((35112 + 2064) * 4);
      const samples = Module._malloc(4);

      const handleGameChange = () => {
        const romPath = romFile.name;
        const biosPath = biosFile.name;
        const romDataArray = new Uint8Array(romData);
        document.getElementById('romHash').innerText = (CRC32.buf(romDataArray) >>> 0).toString(16);

        const gb = gambatte_create();

        const romDataPtr = Module._malloc(romData.byteLength);
        Module.HEAPU8.set(romDataArray, romDataPtr);
        console.log('rom load: ' + gambatte_loadbuf(gb, romDataPtr, romData.byteLength, 3));
        Module._free(romDataPtr);

        const biosDataPtr = Module._malloc(romData.byteLength);
        Module.HEAPU8.set(new Uint8Array(biosData), biosDataPtr);
        console.log('bios load: ' + gambatte_loadbiosbuf(gb, biosDataPtr, biosData.byteLength));
        Module._free(biosDataPtr);

        gambatte_setinputgetter(gb, callback, 0);

        const backbuffer = new ImageData(160, 144);

        const renderer = document.createElement('canvas');
        const rendererContext = renderer.getContext('2d');
        renderer.width = backbuffer.width;
        renderer.height = backbuffer.height;

        const presenter = document.getElementById('gameboy');
        const presenterContext = presenter.getContext('2d');

        const sampleRate = 48000;

        const audioContext = new AudioContext({ sampleRate });

        // reduce volume

        var gainNode = audioContext.createGain();
        gainNode.gain.value = 0.06; // 6 %
        gainNode.connect(audioContext.destination);

        const cyclesPerFrame = 35112;

        let time = 0;
        let lastBufferDuration = 0;

        const renderLoop = () => {
          if (!(audioContext.currentTime - time > 0.001 || time == 0)) {
            animationFrame = requestAnimationFrame(renderLoop);
            return;
          }
          setValue(samples, cyclesPerFrame, 'i32');
          gambatte_runfor(gb, videoBuffer, 160, audioBuffer, samples);
          const bytesProduced = getValue(samples, 'i32') * 4;

          // process audio output

          // divide by 2 channels, 2 bytes per 16 bit signed, and 4 to naively resample to 524k
          const audioSamples = audioContext.createBuffer(2, bytesProduced / 16, 2097152 / 4);
          const channel1Samples = audioSamples.getChannelData(0);
          const channel2Samples = audioSamples.getChannelData(1);
          for (let sample = 0; sample < channel1Samples.length; sample++) {
            // inverse of the division by 16 when creating the buffer size, same logic
            channel1Samples[sample] = (getValue(audioBuffer + sample * 16, 'i16') / 32768.0);
            channel2Samples[sample] = (getValue(audioBuffer + sample * 16 + 2, 'i16') / 32768.0);
          }

          // play audio

          const source = audioContext.createBufferSource();
          source.buffer = audioSamples;
          source.connect(gainNode);

          time = time == 0 ? audioContext.currentTime + 0.003 : time + lastBufferDuration;

          lastBufferDuration = source.buffer.duration;
          source.start(time);

          // process video output

          for (let i = 0; i < backbuffer.data.length; i += 4) {
            const pixel = getValue(videoBuffer + i, 'i32');

            // libretro palette
            const gammaR = gammaColor((pixel >> 16) & 0xff);
            const gammaG = gammaColor((pixel >> 8) & 0xff);
            const gammaB = gammaColor((pixel >> 0) & 0xff);
            const shadedR = clampToUint8(Math.pow(gammaR * .87 + gammaG * .18 - gammaB * .05, 1 / 2.2) * 255 + .5);
            const shadedG = clampToUint8(Math.pow(gammaG * .66 + gammaR * .115 + gammaB * .225, 1 / 2.2) * 255 + .5);
            const shadedB = clampToUint8(Math.pow(gammaB * .79 + gammaR * .14 + gammaG * .07, 1 / 2.2) * 255 + .5);

            backbuffer.data[i + 0] = shadedR;
            backbuffer.data[i + 1] = shadedG;
            backbuffer.data[i + 2] = shadedB;
            backbuffer.data[i + 3] = 0xff;
          }

          rendererContext.putImageData(backbuffer, 0, 0);
          presenterContext.drawImage(renderer, 0, 0);

          animationFrame = requestAnimationFrame(renderLoop);
        };

        pauseInput.addEventListener("click", () => {
          if (pauseInput.innerText === "Pause") {
            pauseInput.innerText = "Play";
            cancelAnimationFrame(animationFrame);
            audioContext.suspend();
          } else {
            pauseInput.innerText = "Pause";
            animationFrame = requestAnimationFrame(renderLoop);
            audioContext.resume();
          }
        });

        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            cancelAnimationFrame(animationFrame);
            audioContext.suspend();
          } else {
            animationFrame = requestAnimationFrame(renderLoop);
            audioContext.resume();
          }
        });

        animationFrame = requestAnimationFrame(renderLoop);
      }
    }
  </script>
</body>

</html>
